<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="walkTrail">

	<resultMap id="LocationMap" type="com.runningdog.vo.LocationVo">
		<result column="locationNo" property="locationNo"></result>
		<result column="si" property="si"></result>
		<result column="gu" property="gu"></result>
		<result column="dong" property="dong"></result>
	</resultMap>
	
	<resultMap id="UsersMap" type="com.runningdog.vo.UsersVo">
		<result column="userNo" property="userNo"></result>
		<result column="id" property="id"></result>
		<result column="password" property="password"></result>
		<result column="userName" property="name"></result>
		<result column="code" property="code"></result>
		<result column="birth" property="birth"></result>
		<result column="gender" property="gender"></result>
		<result column="status" property="status"></result>
		<collection property="locationVo" resultMap="LocationMap"></collection>
	</resultMap>
	
	<resultMap id="TrailMap" type="com.runningdog.vo.TrailVo">
		<result column="trailNo" property="trailNo"></result>
		<result column="name" property="name"></result>
		<result column="spot" property="spot"></result>
		<result column="distance" property="distance"></result>
		<result column="eta" property="eta"></result>
		<result column="parking" property="parking"></result>
		<result column="restroom" property="restroom"></result>
		<result column="trashCan" property="trashCan"></result>
		<result column="explanation" property="explanation"></result>
		<result column="regDate" property="regDate"></result>
		<result column="updateDate" property="updateDate"></result>
		<result column="status" property="status"></result>
		<collection property="usersVo" resultMap="UsersMap"></collection>
		<collection property="locationVo" resultMap="LocationMap"></collection>
	</resultMap>
	
	<resultMap id="WalkLogMap" type="com.runningdog.vo.WalkLogVo">
		<result column="walkLogNo" property="walkLogNo"></result>
		<result column="regDate" property="regDate"></result>
		<result column="startTime" property="startTime"></result>
		<result column="endTime" property="endTime"></result>
		<result column="logTime" property="logTime"></result>
		<result column="distance" property="distance"></result>
		<result column="content" property="content"></result>
		<result column="security" property="security"></result>
		<result column="status" property="status"></result>
		<collection property="usersVo" resultMap="UsersMap"></collection>
		<collection property="locationVo" resultMap="LocationMap"></collection>
	</resultMap>
	
	<resultMap id="TrailCmtMap" type="com.runningdog.vo.TrailCmtVo">
		<result column="trailCmtNo" property="trailCmtNo"></result>
		<result column="regDate" property="regDate"></result>
		<result column="content" property="content"></result>
		<result column="status" property="status"></result>
		<collection property="trailVo" resultMap="TrailMap"></collection>
		<collection property="usersVo" resultMap="UsersMap"></collection>
	</resultMap>

	<!-- trailMain -->
	
	<!-- 유저 설정 위치 -->
	<select id="userLocation" parameterType="int" resultType="com.runningdog.vo.LocationVo">
		 <![CDATA[
			SELECT l.locationNo
			       ,l.si
			       ,l.gu
			       ,l.dong
			  FROM users u, location l
			 WHERE u.locationNo = l.locationNo
			   AND u.userNo = #{userNo}
		 ]]>
	</select>
	
	<!-- 게스트 설정 위치 -->
	<select id="guestLocation" resultType="com.runningdog.vo.LocationVo">
		 <![CDATA[
			SELECT locationNo
			       ,si
			       ,gu
			       ,dong
			  FROM location
			 WHERE gu LIKE '%전체%'
		 ]]>
	</select>

	<!-- 산책로 목록 -->
	<select id="trailList" parameterType="java.util.Map" resultType="com.runningdog.vo.TrailVo">
		<![CDATA[
			SELECT ort.trailNo
			       ,ort.name
			       ,ort.distance
			       ,ort.eta
			       ,ort.regDate
			  FROM (SELECT ROWNUM rn
			               ,ot.trailNo
			               ,ot.name
			               ,ot.distance
			               ,ot.eta
			               ,ot.regDate
			          FROM (SELECT t.trailNo
			                       ,t.name
			                       ,t.distance
			                       ,t.eta
			                       ,TO_CHAR(t.regdate, 'YYYY-MM-DD') regDate
		]]>
		<if test='listKey == "main" || listKey == "my"'>
			<![CDATA[
				  			  FROM coords c, trail t
			]]>
		</if>
		<if test='listKey == "star"'>
			<![CDATA[
				  			  FROM coords c, trailStar ts, trail t
			]]>
		</if>
		<if test='tags.size != 0'>
			<![CDATA[
							  JOIN
			]]>
		</if>
		<if test='tags.size == 0'>
			<![CDATA[
							  LEFT OUTER JOIN
			]]>
		</if>
		<if test='filter == 0'>
			<![CDATA[
			                                  ( SELECT COUNT(tt.walkLogNo) cnt
			                                           ,tt.trailNo
			                                      FROM trailUsed tt, trailTag ta
			                                     WHERE tt.trailNo = ta.trailNo
			]]>
		</if>		
		<if test='filter == 1'>
			<![CDATA[
			                                  ( SELECT COUNT(tt.userNo) cnt
			                                           ,tt.trailNo
			                                      FROM trailStar tt, trailTag ta
			                                     WHERE tt.trailNo = ta.trailNo
			]]>
		</if>
		<if test='filter == 2'>
			<![CDATA[
			                                  ( SELECT COUNT(tt.userNo) cnt
			                                           ,tt.trailNo
			                                      FROM trailCmt tt, trailTag ta
			                                     WHERE tt.trailNo = ta.trailNo
			                                       AND tt.status = 'T'
			]]>
		</if>
		<if test='filter == 3'>
			<![CDATA[
			                                  ( SELECT ta.trailNo
			                                      FROM trailTag ta
			                                     WHERE ta.trailNo > 0
			]]>
		</if>
		<if test='tags.size != 0'>
			<![CDATA[
												   AND ta.tagName IN
			]]>
			<foreach collection="tags" item="item" index="index" separator="," open="(" close=")">
				#{item}
			</foreach>
		</if>
		<if test='filter == 0 || filter == 1 || filter == 2'>
			<![CDATA[
				  			 					 GROUP BY tt.trailNo ) gt
			]]>
		</if>
		<if test='filter == 3'>
			<![CDATA[
				  								 GROUP BY ta.trailNo ) gt
			]]>
		</if>
		<![CDATA[
								ON t.trailNo = gt.trailNo
			                 WHERE t.trailNo = c.useNo
			                   AND c.type = 'trail'
			                   AND c.coordorder = 1
			                   AND c.lng BETWEEN #{coordsMap.swX} AND #{coordsMap.neX}
			   				   AND c.lat BETWEEN #{coordsMap.swY} AND #{coordsMap.neY}
			                   AND t.status = 'T'
		]]>
		<if test='listKey == "my"'>
			<![CDATA[
				  			   AND t.userNo = #{userNo}
			]]>
		</if>
		<if test='listKey == "star"'>
			<![CDATA[
							   AND t.trailNo = ts.trailNo
				  			   AND ts.userNo = #{userNo}
			]]>
		</if>
		<if test='filter == 0 || filter == 1 || filter == 2'>
			<![CDATA[
				  			 ORDER BY gt.cnt DESC, regDate DESC
			]]>
		</if>
		<if test='filter == 3'>
			<![CDATA[
				  			 ORDER BY t.regDate DESC
			]]>
		</if>
		<![CDATA[
			               ) ot
			       ) ort
			 WHERE ort.rn >= 1
			   AND ort.rn <= 10
		 ]]>
	</select>

	<!-- 산책로 좌표 목록 -->
	<select id="coordsList" parameterType="int" resultType="com.runningdog.vo.CoordsVo">
		 <![CDATA[
			SELECT c.useNo
			       ,c.coordOrder
			       ,c.lat
			       ,c.lng
			  FROM trail t, coords c
			 WHERE t.trailNo = c.useNo
			   AND c.type = 'trail'
			   AND c.useNo = #{trailNo}
			   AND t.status = 'T'
			 ORDER BY c.coordOrder
		 ]]>
	</select>
	
	<!-- 산책로 정보 -->
	<select id="trailDetail" parameterType="int" resultMap="TrailMap">
		 <![CDATA[
			SELECT t.trailNo
			       ,t.name
			       ,t.spot
			       ,t.distance
			       ,t.eta
			       ,t.parking
			       ,t.restroom
			       ,t.trashcan
			       ,t.explanation
			       ,TO_CHAR(t.regdate, 'YY-MM-DD') regDate
			       ,TO_CHAR(t.updatedate, 'YY-MM-DD') updateDate
			       ,u.userNo
			       ,u.name userName
			  FROM trail t, users u
			 WHERE t.userNo = u.userNo
			   AND t.trailNo = #{trailNo}
		 ]]>
	</select>

	<!-- 유저 프로필 -->
	<select id="userImg" parameterType="int" resultType="com.runningdog.vo.ImagesVo">
		 <![CDATA[
			SELECT i.orgName
			       ,i.saveName
			       ,i.filePath
			  FROM users u, images i
			 WHERE i.type = 'users'
			   AND i.useNo = #{userNo}
		 ]]>
	</select>
	
	<!-- 산책로 이용자수 -->
	<select id="trailUsedCnt" parameterType="int" resultType="int">
		 <![CDATA[
			SELECT COUNT(*)
			  FROM trailUsed
			 WHERE trailNo = #{trailNo}
		 ]]>
	</select>
	
	<!-- 산책로 찜 갯수 -->
	<select id="trailStarCnt" parameterType="int" resultType="int">
		 <![CDATA[
			SELECT COUNT(*)
			  FROM trailStar
			 WHERE trailNo = #{trailNo}
		 ]]>
	</select>
	
	<!-- 산책로 후기 갯수 -->
	<select id="trailCmtCnt" parameterType="int" resultType="int">
		 <![CDATA[
			SELECT COUNT(*)
			  FROM trailCmt
			 WHERE trailNo = #{trailNo}
		 ]]>
	</select>
	
	<!-- 산책일지 목록 -->
	<select id="walkLogList" parameterType="java.util.Map" resultType="com.runningdog.vo.WalkLogVo">
		<![CDATA[
			SELECT ort.walkLogNo
			       ,ort.userNo
			       ,ort.distance
			       ,ort.logTime
			       ,ort.regDate
			  FROM (SELECT ROWNUM rn
			               ,ot.walkLogNo
			               ,ot.userNo
			               ,ot.distance
			               ,ot.logTime
			               ,ot.regDate
			          FROM (SELECT w.walkLogNo
			                       ,w.userNo
			                       ,w.distance
			                       ,w.logTime
			                       ,TO_CHAR(w.regdate, 'YY-MM-DD HH24:MI:SS') regDate
			                  FROM coords c, walkLog w
		]]>
		<if test='filter == 2'>
			<![CDATA[
							  LEFT OUTER JOIN ( SELECT COUNT(userNo) cnt
			                                           ,useNo
			                                      FROM userLike
			                                     WHERE type = 'walkLog'
			                                     GROUP BY useNo ) gt
			                    ON w.walkLogNo = gt.useNo
			]]>
		</if>
		<![CDATA[
			                 WHERE w.walkLogNo = c.useNo
			                   AND c.type = 'walkLog'
			                   AND c.coordorder = 1
			                   AND c.lng BETWEEN #{coordsMap.swX} AND #{coordsMap.neX}
			   				   AND c.lat BETWEEN #{coordsMap.swY} AND #{coordsMap.neY}
			                   AND w.status = 'T'
			                   AND w.userNo = #{userNo}
		]]>
		<if test='filter == 0'>
			<![CDATA[
							 ORDER BY regDate DESC
			]]>
		</if>
		<if test='filter == 1'>
			<![CDATA[
							 ORDER BY regDate ASC
			]]>
		</if>
		<if test='filter == 2'>
			<![CDATA[
							 ORDER BY gt.cnt DESC, regDate DESC
			]]>
		</if>
		<![CDATA[
			               ) ot
			       ) ort
			 WHERE ort.rn >= 1
			   AND ort.rn <= 10
		 ]]>
	</select>
	
	<!-- 산책일지 좌표 -->
	<select id="walkLogCoords" parameterType="int" resultType="com.runningdog.vo.CoordsVo">
		 <![CDATA[
			SELECT c.useNo
			       ,c.coordOrder
			       ,c.lat
			       ,c.lng
			  FROM walkLog w, coords c
			 WHERE w.walkLogNo = c.useNo
			   AND c.type = 'walkLog'
			   AND c.useNo = #{walkLogNo}
			   AND w.status = 'T'
			 ORDER BY c.coordOrder
		 ]]>
	</select>
	
	<!-- 산책일지 목록 페이징 테스트 -->
	<select id="walkLogListTest" parameterType="java.util.Map" resultType="com.runningdog.vo.WalkLogVo">
		<![CDATA[
			SELECT ort.walkLogNo
			       ,ort.userNo
			       ,ort.distance
			       ,ort.logTime
			       ,ort.regDate
			  FROM (SELECT ROWNUM rn
			               ,ot.walkLogNo
			               ,ot.userNo
			               ,ot.distance
			               ,ot.logTime
			               ,ot.regDate
			          FROM (SELECT w.walkLogNo
			                       ,w.userNo
			                       ,w.distance
			                       ,w.logTime
			                       ,TO_CHAR(w.regdate, 'YY-MM-DD HH24:MI:SS') regDate
			                  FROM coords c, walkLog w
		]]>
		<if test='filter == 2'>
			<![CDATA[
							  LEFT OUTER JOIN ( SELECT COUNT(userNo) cnt
			                                           ,useNo
			                                      FROM userLike
			                                     WHERE type = 'walkLog'
			                                     GROUP BY useNo ) gt
			                    ON w.walkLogNo = gt.useNo
			]]>
		</if>
		<![CDATA[
			                 WHERE w.walkLogNo = c.useNo
			                   AND c.type = 'walkLog'
			                   AND c.coordorder = 1
			                   AND c.lng BETWEEN #{coordsMap.swX} AND #{coordsMap.neX}
			   				   AND c.lat BETWEEN #{coordsMap.swY} AND #{coordsMap.neY}
			                   AND w.status = 'T'
			                   AND w.userNo = #{userNo}
		]]>
		<if test='filter == 0'>
			<![CDATA[
							 ORDER BY regDate DESC
			]]>
		</if>
		<if test='filter == 1'>
			<![CDATA[
							 ORDER BY regDate ASC
			]]>
		</if>
		<if test='filter == 2'>
			<![CDATA[
							 ORDER BY gt.cnt DESC, regDate DESC
			]]>
		</if>
		<![CDATA[
			               ) ot
			       ) ort
			 WHERE ort.rn >= 1
			   AND ort.rn <= 10
		 ]]>
	</select>
	
	<!-- trailForm -->
	
	<!-- 산책로 이름 중복확인 -->
	<select id="confirmName" parameterType="com.runningdog.vo.TrailVo" resultType="int">
		<![CDATA[
			SELECT COUNT(*)
			  FROM trail
			 WHERE name = #{name}
		]]>
	</select>
	
	<!-- 산책로 등록 -->
	<insert id="trailInsert" parameterType="com.runningdog.vo.TrailVo">
	<selectKey keyProperty="trailNo" resultType="int" order="BEFORE">	
		select seq_trail_no.NEXTVAL from dual
	</selectKey>
	<![CDATA[
		INSERT INTO trail
		VALUES(#{trailNo}, #{usersVo.userNo}, #{locationVo.locationNo}, #{name}, #{spot}, #{distance}, #{eta}, #{parking}, #{restroom}, #{trashCan}, #{explanation}, sysdate, sysdate, 'T')
	]]>
	</insert>
	
	<!-- 산책로 태그 등록 -->
	<insert id="trailTagInsert" parameterType="com.runningdog.vo.TrailTagVo">
	<![CDATA[
		INSERT INTO trailTag
		VALUES(seq_trailtag_no.NEXTVAL, #{trailVo.trailNo}, #{tagName})
	]]>
	</insert>
	
	<!-- 산책로 좌표 등록 -->
	<insert id="trailCoordsInsert" parameterType="com.runningdog.vo.CoordsVo">
	<![CDATA[
		INSERT INTO coords
		VALUES (seq_coords_no.NEXTVAL, #{type}, #{useNo}, #{coordOrder}, #{lat}, #{lng})
	]]>
	</insert>
	
	<!-- trailDetail -->
	
	<!-- 산책로 태그 -->
	<select id="tagList" parameterType="int" resultType="com.runningdog.vo.TrailTagVo">
		 <![CDATA[
			SELECT tagName
			  FROM trailTag
			 WHERE trailNo = #{trailNo}
		 ]]>
	</select>
	
	<!-- 산책로 정보 좌표 -->
	<select id="markerCoords" parameterType="com.runningdog.vo.CoordsVo" resultType="com.runningdog.vo.CoordsVo">
		 <![CDATA[
			SELECT c.useNo
			       ,c.coordOrder
			       ,c.type
			       ,c.lat
			       ,c.lng
			  FROM trail t, coords c
			 WHERE t.trailNo = c.useNo
			   AND c.type = #{type}
			   AND c.useNo = #{useNo}
		 ]]>
	</select>
	
	<!-- 유저 이용수 -->
	<select id="userUsedCnt" parameterType="com.runningdog.vo.TrailVo" resultType="int">
		 <![CDATA[
			SELECT COUNT(*)
			  FROM trailUsed tu, walkLog w
			 WHERE tu.walklogno = w.walkLogNo
			   AND w.userNo = #{usersVo.userNo}
			   AND tu.trailNo = #{trailNo}
		 ]]>
	</select>
	
	<!-- 유저 상세 -->
	<select id="userDetail" parameterType="int" resultType="com.runningdog.vo.UsersVo">
		 <![CDATA[
			SELECT userNo
			       ,name
			  FROM users
			 WHERE userNo = #{userNo}
		 ]]>
	</select>
	
	<!-- 최근 산책일지 목록 -->
	<select id="userwalkLogList" parameterType="com.runningdog.vo.TrailVo" resultType="com.runningdog.vo.WalkLogVo">
		<![CDATA[
			SELECT ort.walkLogNo
			       ,ort.userNo
			       ,ort.distance
			       ,ort.logTime
			       ,ort.regDate
			  FROM (SELECT ROWNUM rn
			               ,ot.walkLogNo
			               ,ot.userNo
			               ,ot.distance
			               ,ot.logTime
			               ,ot.regDate
			          FROM (SELECT w.walklogNo
			                       ,w.userNo
			                       ,w.distance
			                       ,w.logTime
			                       ,TO_CHAR(w.regdate, 'YY-MM-DD') regDate
			                  FROM trailUsed tu, walkLog w
			                 WHERE tu.walklogno = w.walkLogNo
			                   AND w.status = 'T'
			                   AND w.userNo = #{usersVo.userNo}
			                   AND tu.trailNo = #{trailNo}
			                 ORDER BY regDate DESC
			               ) ot
			       ) ort
			 WHERE ort.rn >= 1
			   AND ort.rn <= 3
		 ]]>
	</select>
	
	<!-- 유저 상세 목록 -->
	<select id="userDetailList" parameterType="int" resultType="com.runningdog.vo.UsersVo">
		 <![CDATA[
			SELECT ort.userNo
			       ,ort.name
			  FROM ( SELECT ROWNUM rn
			               ,s.userNo
			               ,s.name
			          FROM users s, ( SELECT COUNT(*) cnt
			                                 ,u.userNo
			                            FROM trailUsed tu, walkLog w, users u
			                           WHERE tu.walklogno = w.walkLogNo
			                             AND w.userNo = u.userNo
			                             AND tu.trailNo = #{trailNo}
			                           GROUP BY u.userNo
			                           ORDER BY cnt DESC ) ot
			          WHERE s.userNo = ot.userNo
			       ) ort
			 WHERE ort.rn >= 1
			   AND ort.rn <= 5
		 ]]>
	</select>
	
	<!-- 후기 목록 -->
	<select id="cmtList" parameterType="java.util.Map" resultMap="TrailCmtMap">
		 <![CDATA[
			SELECT ort.trailCmtNo
			       ,ort.trailNo
			       ,ort.content
			       ,ort.userNo
			       ,ort.name userName
			       ,ort.regDate
			       ,ort.cnt
			  FROM (SELECT ROWNUM rn
			               ,ot.trailCmtNo
			               ,ot.trailNo
			               ,ot.content
			               ,ot.userNo
			               ,ot.name
			               ,ot.regDate
			               ,ot.cnt
			          FROM (SELECT t.trailCmtNo
			                       ,t.trailNo
			                       ,t.content
			                       ,u.userNo
			                       ,u.name
			                       ,TO_CHAR(t.regdate, 'YY-MM-DD') regDate
			                       ,gt.cnt
			                  FROM users u, trailCmt t
			                  LEFT OUTER JOIN ( SELECT COUNT(likeNo) cnt
			                                           ,useNo
			                                      FROM userLike
			                                     WHERE type = 'trailCmt'
			                                     GROUP BY useNo ) gt
			                    ON t.trailCmtNo = gt.useNo
			                 WHERE t.userNo = u.userNo
			                   AND t.trailNo = #{trailNo}
			                   AND t.status = 'T'
		]]>
		<if test='cmtOrderNav == 0'>
			<![CDATA[
							 ORDER BY DECODE(u.userNo, #{userNo}, 1), regDate DESC
			]]>
		</if>
		<if test='cmtOrderNav == 1'>
			<![CDATA[
							 ORDER BY DECODE(u.userNo, #{userNo}, 1), gt.cnt DESC, regDate DESC
			]]>
		</if>
		<![CDATA[
			               ) ot
			       ) ort
			 WHERE ort.rn >= 1
			   AND ort.rn <= 10
		 ]]>
	</select>
	
	<!-- 후기 이미지 목록 -->
	<select id="cmtImages" parameterType="int" resultType="com.runningdog.vo.ImagesVo">
		 <![CDATA[
			SELECT i.orgName
			       ,i.saveName
			       ,i.filePath
			       ,i.imageOrder
			  FROM trailcmt t, images i
			 WHERE i.type = 'trailCmt'
			   AND i.useNo = #{trailCmtNo}
			 ORDER BY i.imageOrder ASC
		 ]]>
	</select>
	
	<!-- 후기 좋아요수 -->
	<select id="cmtLikeCnt" parameterType="int" resultType="int">
		 <![CDATA[
			SELECT COUNT(*)
			   FROM userLike
			  WHERE type = 'trailCmt'
			    AND useNo = #{trailCmtNo}
		 ]]>
	</select>
	
	<!-- 후기 등록 -->
	<insert id="trailCmtAdd" parameterType="com.runningdog.vo.TrailCmtVo">
	<selectKey keyProperty="trailCmtNo" resultType="int" order="BEFORE">	
		select seq_trailcmt_no.NEXTVAL from dual
	</selectKey>
	<![CDATA[
		INSERT INTO trailCmt
		VALUES(#{trailCmtNo}, #{trailVo.trailNo}, #{usersVo.userNo}, sysdate, #{content}, 'T')
	]]>
	</insert>
	
	<!-- 후기 이미지 업로드 -->
	<insert id="cmtImgAdd" parameterType="com.runningdog.vo.ImagesVo">
	<![CDATA[
		INSERT INTO images
		VALUES(seq_images_no.NEXTVAL, #{orgName}, #{saveName}, #{filePath}, #{fileSize}, 'trailCmt', #{useNo}, #{imageOrder})
	]]>
	</insert>
	
</mapper>
