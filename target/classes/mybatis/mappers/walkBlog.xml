<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="walkBlog">

	<!-- 쿼리문 작성 -->

	<!-- 산책로 가져오기 -->
	<select id="selectBlogOwner" parameterType="java.util.Map" resultType="java.util.Map">
    <![CDATA[
    SELECT name, userNo
    FROM users
    WHERE code = #{paramCode}
    ]]>
</select>

	<select id="selectOwnerNo" parameterType="int" resultType="int">
    <![CDATA[
    SELECT userNo
    FROM users
    WHERE code = #{paramCode}
    ]]>
	</select>


	<select id="selectBannerImg" parameterType="int" resultType="String">
    <![CDATA[
    select IM.saveName as bannerSavename
    from images IM , users US
    where  IM.useNo = US.userNo
    and IM.useNo = (SELECT userNo
    FROM users
    WHERE code = #{paramCode})
    ]]>
	</select>
	

	<select id="selectFollowerNum" parameterType="String" resultType="int">
      <![CDATA[
      
      SELECT count(followeeNo) as followerNum
      from follow
      where followeeNo = (SELECT userNo
                            From users
                            WHERE code = #{paramCode})
      ]]>
	</select>

	<select id="selectFollowingNum" parameterType="String" resultType="int">
      <![CDATA[
      
      SELECT count(followerNo) as followingNum
      from follow
      where followerNo = (SELECT userNo
                            From users
                            WHERE code = #{paramCode})
      ]]>
	</select>



	<select id="didIFollow" resultType="int" parameterType="java.util.Map">
    <![CDATA[
        SELECT count(followNo) as followNo 
        FROM follow
        WHERE followeeNo = #{followeeNo} AND followerNo = #{followerNo}
    ]]>
</select>

<!-- 팔로우 추가 -->
<insert id="insertFollow" parameterType="java.util.Map">
    <![CDATA[
        INSERT INTO follow (followNo, followeeNo, followerNo)
        VALUES (seq_follow_no.NEXTVAL, #{followeeNo}, #{followerNo})
    ]]>
</insert>

<!-- 팔로우 취소 -->
<delete id="deleteFollow" parameterType="java.util.Map">
    <![CDATA[
        DELETE FROM follow
        WHERE followeeNo = #{followeeNo} AND followerNo = #{followerNo}
    ]]>
</delete>

	<select id="walkLogList" resultType="com.runningdog.vo.ShowLogVo" parameterType="String">
      <![CDATA[
		select       WL.walkLogNo,
		       		 US.userNo,
		       	  	 WL.locationNo,
		       		 TO_CHAR(WL.regDate, '""YYYY"년 "MM"월 "DD"일 "HH24"시 "MI"분"') regDate,
		       		 WL.startTime,
		      		 WL.endTime,
		      		 WL.logTime,
		      		 WL.distance,
		      		 WL.content,
		      		 WL.security,
		      		 WL.status,
		      		 US.name,
		      		 WL.title
		             
		from walkLog WL, users US
		where WL.userNo = US.userNo 
		and WL.userNo = (SELECT US.userNo
		                 From users US
		                WHERE code = #{paramCode})
		order by WL.walkLogNo desc
      ]]>
	</select>


	<select id="getShowLogCmtList" parameterType="int" resultType="com.runningdog.vo.ShowLogCmtVo">
    <![CDATA[
        SELECT 
               WC.walkLogCmtNo,
               WC.walkLogNo,
               US.userNo,
               US.name,
               WC.content,
               TO_CHAR(WC.regDate, '""YYYY"년 "MM"월 "DD"일 "HH24"시 "MI"분"') regDate,
               WC.status
        FROM walkLogCmt WC, users US
        where WC.userNo = US.userNo
        and walkLogNo = #{walkLogNo}
        ORDER BY walkLogCmtNo ASC
    ]]>
	</select>

	<delete id="deleteWalkLog" parameterType="int">
	
	<![CDATA[
	update  walkLog
	SET 
    status = 'F'
    
	where walkLogNo = #{no}
	
	
	]]>




	</delete>
	
	<insert id="addComment" parameterType="com.runningdog.vo.ShowLogCmtVo">
    <![CDATA[
        INSERT INTO walkLogCmt (walkLogCmtNo, walkLogNo, userNo, content, regDate, status)
        VALUES (seq_walklogcmt_no.nextval, #{walkLogNo}, #{userNo}, #{content}, SYSDATE, 'T')
    ]]>
</insert>

<select id="getShowLogImageList" parameterType="int" resultType="com.runningdog.vo.WalkLogConImgVo">
    <![CDATA[
        SELECT 
            saveName,
            imageOrder
        FROM images
        WHERE useNo = #{walkLogNo} AND type = 'walkLogCon'
        ORDER BY imageOrder ASC
    ]]>
</select>

<delete id="deleteComment" parameterType="int">
    <![CDATA[
        DELETE FROM walkLogCmt WHERE walkLogCmtNo = #{no}
    ]]>
</delete>

<select id="didIFollow2" resultType="int" parameterType="Map">
      <![CDATA[
      
      SELECT count(followNo) as followNo 
	  from follow
	  where followeeNo =(SELECT userNo
        From users
        WHERE code = #{paramCode}) and followerNo = #{authUserNo}
      ]]>
	</select>
	
	  <select id="getMonthlyStats" parameterType="String" resultType="com.runningdog.vo.MonthlyStatsVo">
    <![CDATA[
        SELECT
            COUNT(*) AS walkCountThisMonth,
            SUM(distance) AS totalDistanceThisMonth,
            SUM(logTime) AS totalLogTimeThisMonth
        FROM walkLog
        WHERE TO_CHAR(regDate, 'YYYY-MM') = TO_CHAR(SYSDATE, 'YYYY-MM')
        AND userNo = (SELECT userNo FROM users WHERE code = #{paramCode})
    ]]>
</select>

    <!-- 전체 산책 통계 가져오기 -->
   <select id="getTotalStats" parameterType="String" resultType="com.runningdog.vo.MonthlyStatsVo">
    <![CDATA[
        SELECT
            COUNT(*) AS walkCountTotal,
            SUM(distance) AS totalDistanceTotal,
            SUM(logTime) AS totalLogTimeTotal
        FROM walkLog
        WHERE userNo = (SELECT userNo FROM users WHERE code = #{paramCode})
    ]]>
</select>




</mapper>