<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="setting">

	<!-- 유저 1명 가져오기 (이미지 제외) -->
	<select id="selectUser" parameterType="int" resultType="com.runningdog.vo.UserVo">
		<![CDATA[
			select  u.name name,
			        u.code code,
			        to_char(u.birth, 'YYYY-MM-DD') birth,
			        u.gender gender,
			        u.locationNo locationNo,
			        l.si si,
			        l.gu gu,
			        l.dong dong,
			        u.status status
			from users u, location l
			where u.userNo = #{userNo}
			and u.locationNo = l.locationNo
		]]>
	</select>

	<!-- id로 no 찾기 -->
	<select id="selectUserNoWithId" parameterType="String" resultType="int">
		<![CDATA[
			select userNo
			from users
			where id = #{id}
		]]>
	</select>


	<!-- 사진 한 장 가져오기 -->
	<select id="selectImg" parameterType="com.runningdog.vo.MainImageVo" resultType="String">
		<![CDATA[
			select saveName
			from images
			where type = #{type}
			and useNo = #{useNo}
		]]>
	</select>

	<!-- 프로필 새로 등록 시 기존 사진 row 지우기 -->
	<delete id="deleteImg" parameterType="com.runningdog.vo.MainImageVo">
		<![CDATA[
			delete from images
			where useNo = #{useNo}
			and type = #{type}
		]]>
	</delete>

	<!-- 이미지 저장 -->
	<insert id="insertImg" parameterType="com.runningdog.vo.MainImageVo">
		<![CDATA[
			insert into images
			values(seq_images_no.nextval, #{orgName}, #{saveName}, #{filePath}, #{fileSize}, #{type}, #{useNo}, 0)
		]]>
	</insert>

	<!-- 회원 정보 수정 -->
	<update id="updateUser" parameterType="com.runningdog.vo.UserVo">
		<![CDATA[
			update users
			set  locationNo = #{locationNo},
			     name = #{name},
			     birth = #{birth, jdbcType = VARCHAR},
			     gender = #{gender, jdbcType = VARCHAR}
			where userNo = #{userNo}
		]]>
	</update>
	
	
	<!-- 동네 검색 -->
	<select id="selectAddressList" parameterType="String" resultType="com.runningdog.vo.UserVo">
		<![CDATA[
			SELECT  locationNo,
			        si,
			        gu,
			        dong
			FROM location
			WHERE gu || dong LIKE REPLACE('%'||#{keyword}||'%', ' ', '')
			order by locationNo asc
		]]>
	</select>
	
	
<!-- 	강아지 	-->

	<!-- 강아지 카드 (리스트) -->
	<select id="selectDogList" parameterType="int" resultType="com.runningdog.vo.DogListVo">
		<![CDATA[
			select  d.dogNo dogNo,
					d.name dogName, 
			        to_char(d.birth, 'YYYY-MM-DD') birth,
			        d.gender gender,
			        d.weight weight,
			        d.kind kind,
			        d.neuter neuter,
			        d.personality personality,
			        d.color color,
			        d.status status,
			        u.name userName,
			        i.saveName saveName
			from dog d, users u, images i
			where u.userNo = d.userNo
			and d.userNo = #{userNo}
			and d.dogNo = i.useNo
			and i.type = 'dog'
			and d.status != 'F'
			order by dogNo asc
		]]>
	</select>
	
	<!-- 댕댕이 등록 -->
	<insert id="insertDog" parameterType="com.runningdog.vo.DogListVo">
		<!-- DogListVo "주소"의 dogNo에 값을 넣는다. -->
		<selectKey keyProperty="dogNo" resultType="int" order="BEFORE">	
			<![CDATA[	
				select seq_dog_no.nextval from dual
			]]>
		</selectKey>
		<![CDATA[
			INSERT INTO dog
			VALUES (#{dogNo}, #{userNo}, #{dogName}, #{birth}, #{gender}, #{weight}, #{kind}, #{neuter}, #{personality}, 'F', #{color}, 'T')
		]]>
	</insert>
	
	<!-- 강아지 카드 1개 -->
	<select id="selectDog" parameterType="int" resultType="com.runningdog.vo.DogListVo">
		<![CDATA[
			select  d.dogNo dogNo,
					d.name dogName, 
			        to_char(d.birth, 'YYYY-MM-DD') birth,
			        d.gender gender,
			        d.weight weight,
			        d.kind kind,
			        d.neuter neuter,
			        d.personality personality,
			        d.color color,
			        d.status status,
			        i.saveName saveName
			from dog d, users u, images i
			where u.userNo = d.userNo
			and d.dogNo = #{dogNo}
			and d.dogNo = i.useNo
			and i.type = 'dog'
			and d.status != 'F'
		]]>
	</select>
	
	
	<!-- 강아지 삭제 (상태 T -> F 변경) -->
	<update id="deleteDog" parameterType="int">
		<![CDATA[
			update dog
			set status = 'F'
			where dogNo = #{dogNo}
		]]>
	</update>



</mapper>






